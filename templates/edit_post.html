<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">

    <title>Edit: {{ title }}</title>

    <!-- Favicon -->
    <link rel="icon" type="image/x-icon" href="/static/favicon.ico">
    <link rel="icon" type="image/png" sizes="16x16" href="/static/favicon-16x16.png">
    <link rel="icon" type="image/png" sizes="32x32" href="/static/favicon-32x32.png">
    <link rel="apple-touch-icon" sizes="180x180" href="/static/favicon-180x180.png">
    <link rel="icon" type="image/png" sizes="192x192" href="/static/favicon-192x192.png">

    <link rel="stylesheet" href="/static/styles.css">
    <link rel="stylesheet" href="/static/bootstrap.min.css">
    <link rel="stylesheet" href="https://use.fontawesome.com/releases/v6.5.2/css/all.css">
    <link rel="stylesheet" href="/static/post-content-style.css">
    <link rel="stylesheet" href="/static/slideshow.css">
    <style>
        body, html {
            height: 100%;
            margin: 0;
            padding: 0;
        }
        .container {
            display: flex;
            flex-direction: column;
            height: 100vh;
        }
        textarea {
            font-size: 16px; /* フォントサイズを16px以上に設定 */
            flex-grow: 1; /* 残りのスペースを占める */
            width: 100%; /* 横幅を100%に設定 */
            margin-bottom: 0; /* 余白をなくす */
        }
        .btn-toolbar {
            display: flex;
            flex-wrap: wrap; /* 自動折り返し */
            gap: 4px;
        }
        .btn-toolbar .btn-group {
            margin-right: 8px; /* グループ間の余白 */
        }
        /* グループ化の視覚的な区切り */
        .btn-group {
            border-right: 2px solid #dee2e6;
            padding-right: 8px;
            margin-right: 8px;
        }
        .btn-group:last-child {
            border-right: none;
        }
        /* Markdown編集ボタンの最小幅を設定（スマホで押しやすく） */
        .btn-group .btn {
            min-width: 38px;
            padding: 8px 10px;
        }
        /* スマホ対応 - 横スクロール1行 */
        @media (max-width: 768px) {
            .btn-toolbar {
                flex-wrap: nowrap; /* 折り返しなし */
                overflow-x: auto; /* 横スクロール有効 */
                -webkit-overflow-scrolling: touch; /* iOS でスムーズスクロール */
                gap: 2px; /* 隙間を狭く */
                padding-bottom: 4px;
                scrollbar-width: none; /* Firefox: スクロールバー非表示 */
            }
            .btn-toolbar::-webkit-scrollbar {
                display: none; /* Webkit系: スクロールバー非表示 */
            }

            /* よく使うボタンを左側に固定表示 */
            .btn-toolbar > .btn-primary {    /* LINE、AI、閲覧、プレビュー（プレビューはスマホでは非表示） */
                position: sticky;
                left: 0;
                z-index: 2;
                background: #0d6efd;
                box-shadow: 2px 0 4px rgba(0,0,0,0.1); /* 固定されていることを示す影 */
            }


            /* グループの区切り線をスマホでは非表示 */
            .btn-group {
                border-right: none;
                padding-right: 4px;
                margin-right: 4px;
            }

            /* ボタンサイズを調整 */
            .btn-toolbar .btn,
            .btn-toolbar .btn-group .btn {
                min-height: 44px; /* タッチ領域確保 */
                white-space: nowrap; /* テキストの折り返しを防ぐ */
            }

            .btn-sm {
                font-size: 0.8rem;
                padding: 0.25rem 0.5rem;
            }

            /* スクロールヒント（右端のグラデーション） */
            .btn-toolbar::after {
                content: '';
                position: sticky;
                right: 0;
                width: 30px;
                height: 100%;
                background: linear-gradient(to right, rgba(255,255,255,0), rgba(255,255,255,0.9));
                pointer-events: none;
                flex-shrink: 0;
            }
        }
        .form-control{
            margin-bottom: 5px;
        }
        .overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.5);
            display: none;
            justify-content: center;
            align-items: center;
            z-index: 2000;
        }
        .dialog {
            background: white;
            padding: 20px;
            border-radius: 5px;
            display: flex;
            flex-direction: column;
            gap: 10px;
            width: 100%; /* 画面の幅いっぱいに広げる */
        }
        .view-link {
            position: fixed;
            top: 10px;
            right: 10px;
            z-index: 1000;
        }
        /* 挿入オーバーレイ用のスタイル */
        #insertOverlay {
            z-index: 2500;
        }
        #insertOverlay .dialog {
            max-width: 400px;
            width: 90%;
        }

        /* AIモーダル用のスタイル */
        #aiOverlay {
            z-index: 3000;
        }
        #aiOverlay .dialog {
            max-width: 600px;
            width: 90%;
        }
        .ai-context-preview {
            max-height: 100px;
            overflow-y: auto;
            background-color: #f8f9fa;
            padding: 8px;
            border-radius: 4px;
            font-size: 0.85em;
            white-space: pre-wrap;
            word-wrap: break-word;
        }

        /* レスポンシブ対応 */
        @media (max-width: 768px) {
            #insertOverlay .dialog {
                width: 95%;
                padding: 15px;
            }
            #aiOverlay .dialog {
                width: 95%;
                padding: 15px;
            }
            #aiPromptInput {
                font-size: 16px; /* iOS zoom prevention */
            }
            #templateSelect {
                font-size: 16px; /* iOS zoom prevention */
            }
        }

        /* プレビュー機能: PC専用（768px以上） */
        @media (min-width: 769px) {
            /* コンテナ */
            .editor-container {
                display: flex;
                gap: 0;
                flex: 1; /* 残りのスペースを占める */
            }

            /* 編集エリア */
            .editor-pane {
                flex: 1;
                min-width: 200px;
                overflow: hidden;
                display: flex;
                flex-direction: column;
            }

            .editor-pane textarea {
                flex: 1;
                resize: none;
            }

            /* リサイザー（ドラッグハンドル） */
            .resizer {
                width: 8px;
                background: #dee2e6;
                cursor: col-resize;
                user-select: none;
                flex-shrink: 0;
                position: relative;
            }

            .resizer:hover {
                background: #0d6efd;
            }

            /* リサイザーの視覚的ヒント */
            .resizer::before {
                content: '';
                position: absolute;
                top: 50%;
                left: 50%;
                transform: translate(-50%, -50%);
                width: 3px;
                height: 30px;
                background: repeating-linear-gradient(
                    to bottom,
                    #fff 0px,
                    #fff 2px,
                    transparent 2px,
                    transparent 6px
                );
            }

            /* プレビューエリア */
            .preview-pane {
                flex: 1;
                min-width: 200px;
                padding: 20px;
                background: #f8f9fa;
                overflow-y: auto;
                border-left: 1px solid #dee2e6;
            }

            .preview-pane.hidden {
                display: none;
            }

            /* プレビューが非表示の時は編集エリアが全幅 */
            .editor-container.preview-hidden .editor-pane {
                flex: 1 1 100%;
            }

            .editor-container.preview-hidden .resizer,
            .editor-container.preview-hidden .preview-pane {
                display: none;
            }

            /* プレビュートグルボタン */
            .preview-toggle {
                display: inline-block;
            }

            /* プレビューペイン内の .main-content スタイル調整 */
            .preview-pane.main-content {
                /* height: auto を削除 - 親の flex: 1 と overflow-y: auto に従う */
                width: 100%;
                padding: 20px;
            }

            /* #preview-content のスタイルは /static/styles.css で定義されています */
        }

        /* スマホ（768px未満）: プレビュー機能を完全無効化 */
        @media (max-width: 768px) {
            .resizer,
            .preview-pane,
            .preview-toggle {
                display: none !important;
            }

            .editor-container {
                display: flex; /* flexコンテナにする */
                flex-direction: column;
                flex: 1; /* 残りのスペースを占める */
            }

            .editor-pane {
                display: flex; /* flexコンテナにする */
                flex-direction: column;
                flex: 1; /* 残りのスペースを占める */
            }

            .editor-pane textarea {
                flex: 1; /* 残りのスペースを占める */
            }
        }

        /* ページ切り替えオーバーレイ用スタイル */
        #switchPageOverlay {
            z-index: 2500;
        }

        #switchPageOverlay .dialog {
            max-width: 600px;
            width: 90%;
        }

        /* バックアップ一覧の横幅をページ切り替えと同じに */
        #backupListOverlay .dialog {
            max-width: 600px;
            width: 90%;
        }

        .page-item {
            padding: 12px 16px;
            border-bottom: 1px solid #dee2e6;
            cursor: pointer;
            transition: background-color 0.2s;
            background-color: white;
        }

        .page-item:hover {
            background-color: #f8f9fa;
        }

        .page-item.selected {
            background-color: #0d6efd;
            color: white;
        }

        .page-item.selected .page-date,
        .page-item.selected .page-filename {
            color: rgba(255, 255, 255, 0.8);
        }

        .page-date {
            font-size: 0.8em;
            color: #666;
            margin-bottom: 4px;
        }

        .page-title {
            font-size: 1em;
            font-weight: 500;
            margin-bottom: 2px;
        }

        .page-filename {
            font-size: 0.75em;
            color: #999;
        }

        .page-list {
            max-height: 60vh;
            overflow-y: auto;
            background: white;
            border: 1px solid #dee2e6;
            border-radius: 4px;
            margin-bottom: 12px;
        }

        /* バックアップ関連のオーバーレイ */
        #backupListOverlay {
            z-index: 3000;
        }

        #backupContentOverlay {
            z-index: 3500;
        }

        #backupContentOverlay .dialog {
            display: flex;
            flex-direction: column;
        }

        .backup-item {
            padding: 12px 16px;
            border-bottom: 1px solid #dee2e6;
            cursor: pointer;
            transition: background-color 0.2s;
            background-color: white;
        }

        .backup-item:hover {
            background-color: #f8f9fa;
        }

        .backup-item.selected {
            background-color: #0d6efd;
            color: white;
        }

        .backup-date {
            font-size: 0.9em;
            font-weight: 500;
            margin-bottom: 4px;
        }

        .backup-relative-time {
            font-size: 0.8em;
            color: #666;
            margin-left: 8px;
        }

        .backup-item.selected .backup-relative-time {
            color: rgba(255, 255, 255, 0.8);
        }

        .backup-filename {
            font-size: 0.75em;
            color: #999;
            margin-top: 4px;
        }

        .backup-item.selected .backup-filename {
            color: rgba(255, 255, 255, 0.7);
        }

        /* 差分ハイライト用のスタイル */
        #backupContentDiff {
            font-size: 14px;
        }

        .diff-line {
            padding: 2px 0;
            margin: 0;
        }

        .diff-line-deleted {
            background-color: #ffe6e6;
            color: #cc0000;
            text-decoration: line-through;
        }

        .diff-line-added {
            background-color: #e6ffe6;
            color: #006600;
        }

        .diff-line-normal {
            background-color: white;
            color: #333;
        }

        .diff-line-number {
            display: inline-block;
            width: 40px;
            color: #999;
            text-align: right;
            padding-right: 10px;
            margin-right: 10px;
            border-right: 1px solid #dee2e6;
            user-select: none;
        }

        /* 差分ボタンのアクティブ状態 */
        #backupDiffButton.active {
            background-color: #0d6efd;
            color: white;
            border-color: #0d6efd;
        }

        /* バックアップ内容モーダルのレイアウト（スマホ対応） */
        .backup-content-dialog {
            display: flex;
            flex-direction: column;
            height: 90vh;
        }

        .backup-content-header {
            flex-shrink: 0;
            padding-bottom: 15px;
            border-bottom: 1px solid #dee2e6;
            margin-bottom: 15px;
        }

        .backup-content-header h5 {
            margin: 0;
        }

        .backup-content-body {
            flex: 1;
            overflow: hidden;
            display: flex;
            flex-direction: column;
            min-height: 0;
        }

        .backup-content-footer {
            flex-shrink: 0;
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 10px;
            padding-top: 15px;
            border-top: 1px solid #dee2e6;
            margin-top: 15px;
        }

        .backup-content-footer .btn {
            padding: 12px 16px;
            font-size: 16px;
            font-weight: 500;
        }

        /* PC表示（768px以上）：横1列配置 */
        @media (min-width: 768px) {
            .backup-content-footer {
                grid-template-columns: auto auto auto 1fr;
                gap: 8px;
            }

            .backup-content-footer .btn {
                padding: 8px 16px;
                font-size: 14px;
            }

            .backup-content-footer #backupContentCloseButton {
                margin-left: auto;
            }
        }

        /* スマホ表示でのボタン調整 */
        @media (max-width: 767px) {
            .backup-content-footer .btn i {
                margin-right: 6px;
            }
        }
    </style>
    <script>
        const csrfToken = "{{ form.csrf_token._value() }}";  // CSRFトークンをJavaScriptに渡す

        document.addEventListener('DOMContentLoaded', () => {
            const contentTextArea = document.getElementById('content');
            if (contentTextArea) {
                contentTextArea.dataset.initialLoad = 'true';
                contentTextArea.value = contentTextArea.value.replace(/\\n/g, '\n');
                
                if (contentTextArea.dataset.initialLoad === 'true') {
                    contentTextArea.focus();
                    contentTextArea.selectionStart = 0;
                    contentTextArea.selectionEnd = 0;
                    contentTextArea.scrollTop = 0;
                    delete contentTextArea.dataset.initialLoad;
                }
            }

            autoSaveContent();

            document.addEventListener('keydown', function(event) {
                if ((event.ctrlKey || event.metaKey) && event.key === 'Enter') {
                    // ページ切り替えモーダルが開いている場合はスキップ
                    const switchPageOverlay = document.getElementById('switchPageOverlay');
                    if (switchPageOverlay && switchPageOverlay.style.display === 'flex') {
                        return;
                    }

                    event.preventDefault();
                    // フォームを送信（保存して遷移）
                    const form = document.querySelector('form');
                    if (form) {
                        form.submit();
                    }
                } else if ((event.ctrlKey || event.metaKey) && event.key === 's') {
                    event.preventDefault();
                    saveWithoutRedirect();
                } else if (event.altKey && (event.code === 'KeyY' || event.key === 'y' || event.key === 'Y')) {
                    event.preventDefault();
                    const currentDate = getCurrentDate();
                    insertTextAtCursor(document.getElementById('content'), currentDate);
                } else if (event.altKey && (event.code === 'KeyH' || event.key === 'h' || event.key === 'H')) {
                    event.preventDefault();
                    const currentTime = getCurrentTime();
                    insertTextAtCursor(document.getElementById('content'), currentTime);
                } else if (event.altKey && (event.code === 'Digit1' || event.key === '1')) {
                    event.preventDefault();
                    cycleHeaderLevel(document.getElementById('content'));
                } else if (event.altKey && (event.code === 'Digit2' || event.key === '2')) {
                    event.preventDefault();
                    cycleDashMark(document.getElementById('content'));
                } else if (event.altKey && (event.code === 'Digit3' || event.key === '3')) {
                    event.preventDefault();
                    cycleNumberMark(document.getElementById('content'));
                } else if (event.altKey && (event.code === 'Digit4' || event.key === '4')) {
                    event.preventDefault();
                    cycleQuoteMark(document.getElementById('content'));
                } else if (event.altKey && (event.code === 'Digit5' || event.key === '5')) {
                    // ALT+5: Bold（選択範囲がある場合のみ）
                    event.preventDefault();
                    const textarea = document.getElementById('content');
                    const start = textarea.selectionStart;
                    const end = textarea.selectionEnd;
                    if (start !== end) { // 選択範囲がある場合のみ実行
                        wrapSelectedTextWith(textarea, '**');
                    }
                } else if (event.altKey && (event.code === 'Digit6' || event.key === '6')) {
                    // ALT+6: 4スペーストグル
                    event.preventDefault();
                    cycleFourSpaces(document.getElementById('content'));
                } else if (event.altKey && event.key === 'ArrowUp') {
                    // ALT+Up: Move cursor to the beginning of the textarea
                    event.preventDefault();
                    const textarea = document.getElementById('content');
                    textarea.selectionStart = 0;
                    textarea.selectionEnd = 0;
                    textarea.focus();
                } else if (event.altKey && event.key === 'ArrowDown') {
                    // ALT+Down: Move cursor to the end of the textarea
                    event.preventDefault();
                    const textarea = document.getElementById('content');
                    textarea.selectionStart = textarea.value.length;
                    textarea.selectionEnd = textarea.value.length;
                    textarea.focus();
                } else if (event.altKey && (event.code === 'KeyA' || event.key === 'a' || event.key === 'A')) {
                    // ALT+A: AIアシスタントを開く
                    event.preventDefault();
                    document.getElementById('aiButton').click();
                }
            });

            // Saveボタン（ツールバー）
            const saveButton = document.getElementById('saveButton');
            if (saveButton) {
                saveButton.addEventListener('click', () => {
                    saveWithoutRedirect();
                });
            }

            // Previewボタン（ツールバー）
            const viewPageButton = document.getElementById('viewPageButton');
            if (viewPageButton) {
                viewPageButton.addEventListener('click', () => {
                    window.open('{{ url_for('post', filename=request.view_args['filename']) }}', '_blank');
                });
            }

            const pasteMermaidButton = document.getElementById('pasteMermaidButton');
            if (pasteMermaidButton) {
                pasteMermaidButton.addEventListener('click', () => {
                    insertTextAtCursor(contentTextArea, '\n```mermaid\n\n```');
                    const insertOverlay = document.getElementById('insertOverlay');
                    if (insertOverlay) {
                        insertOverlay.style.display = 'none';
                    }
                });
            }

            // Markdown書式ボタン: トグル動作
            const insertHashButton = document.getElementById('insertHashButton');
            if (insertHashButton) {
                insertHashButton.addEventListener('click', () => {
                    cycleHeaderLevel(contentTextArea);
                });
            }

            const insertDashButton = document.getElementById('insertDashButton');
            if (insertDashButton) {
                insertDashButton.addEventListener('click', () => {
                    cycleDashMark(contentTextArea);
                });
            }

            const insert1Button = document.getElementById('insert1Button');
            if (insert1Button) {
                insert1Button.addEventListener('click', () => {
                    cycleNumberMark(contentTextArea);
                });
            }

            const insertQuoteButton = document.getElementById('insertQuoteButton');
            if (insertQuoteButton) {
                insertQuoteButton.addEventListener('click', () => {
                    cycleQuoteMark(contentTextArea);
                });
            }

            // その他のボタン: 従来通りの動作
            const insertSpaceButton = document.getElementById('insertSpaceButton');
            if (insertSpaceButton) {
                insertSpaceButton.addEventListener('click', () => {
                    cycleFourSpaces(contentTextArea);
                });
            }

            const insertBoldButton = document.getElementById('insertBoldButton');
            if (insertBoldButton) {
                insertBoldButton.addEventListener('click', () => {
                    wrapSelectedTextWith(contentTextArea, '**');
                });
            }

            contentTextArea.addEventListener('paste', handlePaste);

            // LINEボタンの機能追加
            const lineButton = document.getElementById('lineButton');
            const overlay = document.getElementById('overlay');
            const lineTextInput = document.getElementById('lineTextInput');
            const lineAttachButton = document.getElementById('lineAttachButton');

            lineButton.addEventListener('click', () => {
                // オプション画面を閉じる
                insertOverlay.style.display = 'none';
                // チャット入力画面を開く
                overlay.style.display = 'flex';
                lineTextInput.focus(); // オーバーレイが表示されたときにフォーカスを設定
            });

            let isComposing = false;

            lineTextInput.addEventListener('compositionstart', () => {
                isComposing = true;
            });

            lineTextInput.addEventListener('compositionend', () => {
                isComposing = false;
            });

            lineTextInput.addEventListener('keydown', (event) => {
                if (event.key === 'Enter' && !isComposing) {
                    event.preventDefault();
                    const text = '\n' + lineTextInput.value;
                    insertTextAtCursor(contentTextArea, text);
                    lineTextInput.value = ''; // テキストボックスをクリア
                    lineTextInput.focus();
                }
            });

            lineAttachButton.addEventListener('click', () => {
                document.getElementById('uploadFileButton').click(); 
            });

            overlay.addEventListener('click', (event) => {
                if (event.target === overlay) {
                    overlay.style.display = 'none';
                }
            });

            // 挿入ボタンの機能追加
            const insertButton = document.getElementById('insertButton');
            const insertOverlay = document.getElementById('insertOverlay');
            const insertCancelButton = document.getElementById('insertCancelButton');
            const uploadFileButton = document.getElementById('uploadFileButton');

            if (insertButton && insertOverlay) {
                insertButton.addEventListener('click', () => {
                    insertOverlay.style.display = 'flex';
                });

                // 背景クリックでオーバーレイを閉じる
                insertOverlay.addEventListener('click', (event) => {
                    if (event.target === insertOverlay) {
                        insertOverlay.style.display = 'none';
                    }
                });

                // キャンセルボタン
                if (insertCancelButton) {
                    insertCancelButton.addEventListener('click', () => {
                        insertOverlay.style.display = 'none';
                    });
                }

                // ファイルアップロードボタンクリック時にオーバーレイを閉じる
                if (uploadFileButton) {
                    uploadFileButton.addEventListener('click', () => {
                        insertOverlay.style.display = 'none';
                    });
                }
            }

            // ESCキーが押されたときにオーバーレイを非表示にする
            document.addEventListener('keydown', (event) => {
                if (event.key === 'Escape') {
                    overlay.style.display = 'none';
                    if (document.getElementById('aiOverlay')) {
                        document.getElementById('aiOverlay').style.display = 'none';
                    }
                    if (insertOverlay) {
                        insertOverlay.style.display = 'none';
                    }
                }
            });

            // YYボタンとHHボタンのイベントリスナーを追加
            const insertDateButton = document.getElementById('insertDateButton');
            const insertTimeButton = document.getElementById('insertTimeButton');

            if (insertDateButton) {
                insertDateButton.addEventListener('click', () => {
                    const currentDate = getCurrentDate();
                    insertTextAtCursor(contentTextArea, currentDate);
                    if (insertOverlay) {
                        insertOverlay.style.display = 'none';
                    }
                });
            }

            if (insertTimeButton) {
                insertTimeButton.addEventListener('click', () => {
                    const currentTime = getCurrentTime();
                    insertTextAtCursor(contentTextArea, currentTime);
                    if (insertOverlay) {
                        insertOverlay.style.display = 'none';
                    }
                });
            }

            // AI機能の実装（プリセット対応）
            const aiButton = document.getElementById('aiButton');
            const aiOverlay = document.getElementById('aiOverlay');
            const aiPromptInput = document.getElementById('aiPromptInput');
            const aiContextPreview = document.getElementById('aiContextPreview');
            const aiSendButton = document.getElementById('aiSendButton');
            const aiCancelButton = document.getElementById('aiCancelButton');
            const aiButtonText = document.getElementById('aiButtonText');
            const aiSpinner = document.getElementById('aiSpinner');
            const templateSelect = document.getElementById('templateSelect');
            const systemPromptSelect = document.getElementById('systemPromptSelect');

            let aiContextText = '';
            let aiCursorPosition = 0;
            let aiPresets = null;
            let selectedTemplateId = null;

            // AIプリセットを読み込む
            async function loadAIPresets() {
                try {
                    const response = await fetch('/ai_presets', {
                        headers: {
                            'X-CSRFToken': csrfToken
                        }
                    });
                    if (response.ok) {
                        aiPresets = await response.json();
                        renderTemplateSelect();
                        renderSystemPromptSelect();
                    } else {
                        console.error('Failed to load AI presets');
                    }
                } catch (error) {
                    console.error('Error loading AI presets:', error);
                }
            }

            // テンプレートドロップダウンを描画
            function renderTemplateSelect() {
                if (!aiPresets || !aiPresets.prompt_templates) return;

                templateSelect.innerHTML = '<option value="">-- テンプレートを選択 --</option>';

                Object.entries(aiPresets.prompt_templates).forEach(([id, template]) => {
                    const option = document.createElement('option');
                    option.value = id;
                    option.textContent = `${template.icon} ${template.name}`;
                    templateSelect.appendChild(option);
                });
            }

            // テンプレート選択時の処理
            templateSelect.addEventListener('change', () => {
                const selectedId = templateSelect.value;
                if (selectedId && aiPresets.prompt_templates[selectedId]) {
                    selectedTemplateId = selectedId;
                    aiPromptInput.value = aiPresets.prompt_templates[selectedId].prompt;
                } else {
                    selectedTemplateId = null;
                    aiPromptInput.value = '';
                }
            });

            // システムプロンプトセレクトを描画
            function renderSystemPromptSelect() {
                if (!aiPresets || !aiPresets.system_prompts) return;

                systemPromptSelect.innerHTML = '';
                const selectedPromptId = aiPresets.user_presets?.selected_system_prompt || 'default';

                Object.entries(aiPresets.system_prompts).forEach(([id, prompt]) => {
                    const option = document.createElement('option');
                    option.value = id;
                    option.textContent = prompt.name;
                    if (id === selectedPromptId) {
                        option.selected = true;
                    }
                    systemPromptSelect.appendChild(option);
                });
            }

            // システムプロンプトの選択変更を保存
            systemPromptSelect.addEventListener('change', async () => {
                const selectedId = systemPromptSelect.value;
                try {
                    await fetch('/ai_presets/system_prompt', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                            'X-CSRFToken': csrfToken
                        },
                        body: JSON.stringify({ preset_id: selectedId })
                    });
                } catch (error) {
                    console.error('Error saving system prompt:', error);
                }
            });

            // ページロード時にプリセットを読み込む
            loadAIPresets();

            // AIボタンクリック
            aiButton.addEventListener('click', () => {
                const start = contentTextArea.selectionStart;
                const end = contentTextArea.selectionEnd;
                const selectedText = contentTextArea.value.substring(start, end);

                if (selectedText) {
                    // テキスト選択時: コンテキストとして保存
                    aiContextText = selectedText;
                    aiCursorPosition = end; // 選択範囲の終わりにカーソルを設定
                    aiContextPreview.textContent = selectedText;
                    aiContextPreview.style.display = 'block';
                } else {
                    // 未選択時: コンテキストなし
                    aiContextText = '';
                    aiCursorPosition = start; // 現在のカーソル位置
                    aiContextPreview.style.display = 'none';
                }

                aiOverlay.style.display = 'flex';
                aiPromptInput.focus();
            });

            // AI送信ボタンクリック
            async function sendAIRequest() {
                let prompt = aiPromptInput.value.trim();

                // テンプレートが選択されていてプロンプト入力がない場合、テンプレートのプロンプトを使用
                if (selectedTemplateId && !prompt && aiPresets.prompt_templates[selectedTemplateId]) {
                    prompt = aiPresets.prompt_templates[selectedTemplateId].prompt;
                }

                if (!prompt) {
                    alert('テンプレートを選択するか、問い合わせ内容を入力してください');
                    return;
                }

                // ローディング状態に変更
                aiButtonText.style.display = 'none';
                aiSpinner.style.display = 'inline';
                aiSendButton.disabled = true;
                aiCancelButton.disabled = true;
                aiPromptInput.disabled = true;

                try {
                    const systemPromptId = systemPromptSelect.value;
                    const response = await fetch('/ai_assist', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                            'X-CSRFToken': csrfToken
                        },
                        body: JSON.stringify({
                            prompt: prompt,
                            context: aiContextText,
                            system_prompt_id: systemPromptId
                        })
                    });

                    const data = await response.json();

                    if (response.ok) {
                        // AI応答をテキストエリアに挿入
                        const aiResponse = data.response;
                        const insertText = '\n\n---\n**( ・∀・)つ〃∩＜どうも！**\n' + aiResponse + '\n\n---\n';

                        // カーソル位置に挿入
                        const value = contentTextArea.value;
                        contentTextArea.value = value.slice(0, aiCursorPosition) + insertText + value.slice(aiCursorPosition);

                        // カーソルを挿入後の位置に移動
                        const newPosition = aiCursorPosition + insertText.length;
                        contentTextArea.selectionStart = contentTextArea.selectionEnd = newPosition;
                        contentTextArea.focus();

                        // プレビュー更新のために input イベントを発火
                        const event = new Event('input', { bubbles: true });
                        contentTextArea.dispatchEvent(event);

                        // モーダルを閉じる
                        aiOverlay.style.display = 'none';

                        // リセット
                        selectedTemplateId = null;
                        aiPromptInput.value = '';
                        templateSelect.value = '';
                    } else {
                        alert('エラー: ' + (data.error || '不明なエラーが発生しました'));
                    }
                } catch (error) {
                    console.error('AI処理エラー:', error);
                    alert('AI処理に失敗しました: ' + error.message);
                } finally {
                    // ローディング状態を解除
                    aiButtonText.style.display = 'inline';
                    aiSpinner.style.display = 'none';
                    aiSendButton.disabled = false;
                    aiCancelButton.disabled = false;
                    aiPromptInput.disabled = false;
                }
            }

            aiSendButton.addEventListener('click', sendAIRequest);

            // AIキャンセルボタンクリック
            aiCancelButton.addEventListener('click', () => {
                aiOverlay.style.display = 'none';
                selectedTemplateId = null;
                aiPromptInput.value = '';
                templateSelect.value = '';
            });

            // AIオーバーレイクリック（背景クリック）
            aiOverlay.addEventListener('click', (event) => {
                if (event.target === aiOverlay) {
                    aiOverlay.style.display = 'none';
                    selectedTemplateId = null;
                    aiPromptInput.value = '';
                    templateSelect.value = '';
                }
            });

            // AIプロンプト入力でのIME制御
            let isAIComposing = false;
            aiPromptInput.addEventListener('compositionstart', () => {
                isAIComposing = true;
            });
            aiPromptInput.addEventListener('compositionend', () => {
                isAIComposing = false;
            });

            // AIプロンプト入力でのCtrl+Enter送信
            aiPromptInput.addEventListener('keydown', (event) => {
                if ((event.ctrlKey || event.metaKey) && event.key === 'Enter' && !isAIComposing) {
                    event.preventDefault();
                    sendAIRequest();
                }
            });

            // ========== プレビュー機能 ==========
            const previewToggleButton = document.getElementById('previewToggleButton');
            const previewPane = document.getElementById('previewPane');
            const resizer = document.getElementById('resizer');
            const editorContainer = document.querySelector('.editor-container');
            const editorPane = document.querySelector('.editor-pane');

            if (previewToggleButton && previewPane && resizer) {
                let previewVisible = false;

                // localStorageから前回の状態を復元
                const savedPreviewState = localStorage.getItem('previewVisible');
                if (savedPreviewState === 'true') {
                    previewVisible = true;
                }

                // Marked.js設定（post.htmlと同じ設定）
                const renderer = new marked.Renderer();

                renderer.code = function(code, language) {
                    const codeText = (typeof code === 'string' ? code : code.text).trim()
                        .replace(/</g, '&lt;')
                        .replace(/>/g, '&gt;');
                    const lang = (language === undefined) ? code.lang : language;

                    if (lang === undefined) {
                        return `<pre>${codeText}</pre>`;
                    }

                    if (lang === 'mermaid') {
                        return `<div class="mermaid">${codeText}</div>`;
                    } else {
                        return `<pre><code>${codeText}</code></pre>`;
                    }
                };

                renderer.image = function(href, title, text) {
                    if (typeof href === 'object' && href !== null) {
                        href = href.href || 'default-image-path.jpg';
                    } else if (typeof href !== 'string') {
                        console.error('Invalid href:', href);
                        href = 'default-image-path.jpg';
                    }
                    text = text || 'image';
                    return `<img loading="lazy" src="${href}" alt="${text}">`;
                };

                marked.setOptions({
                    renderer: renderer,
                    sanitize: true
                });

                // テーブルのレンダリングをカスタマイズ
                const originalTable = renderer.table;
                renderer.table = function(header, body) {
                    const table = originalTable.call(this, header, body);
                    return '<div class="table-responsive">' + table + '</div>';
                };

                // Mermaid初期化
                mermaid.initialize({ startOnLoad: false });

                // プレビュー更新関数
                let updateTimeout;
                function updatePreview() {
                    clearTimeout(updateTimeout);
                    updateTimeout = setTimeout(() => {
                        const markdown = contentTextArea.value;

                        // タイトルとタグを除外（3行目以降をプレビュー）
                        const lines = markdown.split('\n');
                        const contentOnly = lines.slice(2).join('\n');

                        try {
                            const html = marked.parse(contentOnly);

                            // 画面表示の際、以下のタグをエスケープ（post.htmlと同じ処理）
                            const tagsToEscape = ['title', 'script', 'style', 'iframe', 'object', 'embed', 'form', 'input', 'link', 'meta'];
                            let escapedHtml = html;
                            tagsToEscape.forEach(tag => {
                                const regex = new RegExp(`<${tag}>`, 'g');
                                const closingRegex = new RegExp(`</${tag}>`, 'g');
                                escapedHtml = escapedHtml.replace(regex, `&lt;${tag}&gt;`).replace(closingRegex, `&lt;/${tag}&gt;`);
                            });

                            // preview-content div に挿入（styles.cssの#contentスタイルを適用するため）
                            const previewContent = document.getElementById('preview-content');
                            previewContent.innerHTML = escapedHtml;

                            // Mermaidダイアグラムを再レンダリング
                            const mermaidElements = previewContent.querySelectorAll('.mermaid');
                            mermaidElements.forEach((element, index) => {
                                const id = `mermaid-${Date.now()}-${index}`;
                                mermaid.render(id, element.textContent).then(result => {
                                    element.innerHTML = result.svg;
                                }).catch(error => {
                                    console.error('Mermaid rendering error:', error);
                                    element.innerHTML = `<pre>Mermaid Error: ${error.message}</pre>`;
                                });
                            });

                            // スライドショー機能を初期化
                            if (typeof initializeSlideshowImages === 'function') {
                                initializeSlideshowImages('#preview-content');
                            }
                        } catch (error) {
                            console.error('Markdown rendering error:', error);
                            const previewContent = document.getElementById('preview-content');
                            previewContent.innerHTML = '<p>Markdown rendering error</p>';
                        }
                    }, 300); // 300ms debounce
                }

                // プレビュートグル関数
                const togglePreview = () => {
                    previewVisible = !previewVisible;

                    // localStorageに状態を保存
                    localStorage.setItem('previewVisible', previewVisible);

                    if (previewVisible) {
                        previewPane.classList.remove('hidden');
                        editorContainer.classList.remove('preview-hidden');
                        editorPane.style.flex = '1';
                        previewPane.style.flex = '1';
                        updatePreview();
                    } else {
                        previewPane.classList.add('hidden');
                        editorContainer.classList.add('preview-hidden');
                    }
                };

                // プレビュートグルボタン（ツールバー）
                previewToggleButton.addEventListener('click', togglePreview);

                // リアルタイムプレビュー更新
                contentTextArea.addEventListener('input', () => {
                    if (previewVisible) {
                        updatePreview();
                    }
                });

                // localStorageの状態に基づいてプレビューを初期表示
                if (previewVisible) {
                    previewPane.classList.remove('hidden');
                    editorContainer.classList.remove('preview-hidden');
                    editorPane.style.flex = '1';
                    previewPane.style.flex = '1';
                    updatePreview();
                }

                // リサイザーのドラッグ機能
                let isResizing = false;
                let startX = 0;
                let startEditorWidth = 0;
                let startPreviewWidth = 0;

                resizer.addEventListener('mousedown', (e) => {
                    if (!previewVisible) return;

                    isResizing = true;
                    startX = e.clientX;
                    startEditorWidth = editorPane.offsetWidth;
                    startPreviewWidth = previewPane.offsetWidth;

                    document.body.style.cursor = 'col-resize';
                    document.body.style.userSelect = 'none';

                    e.preventDefault();
                });

                document.addEventListener('mousemove', (e) => {
                    if (!isResizing) return;

                    const deltaX = e.clientX - startX;
                    const containerWidth = editorContainer.offsetWidth;
                    const resizerWidth = resizer.offsetWidth;

                    const newEditorWidth = startEditorWidth + deltaX;
                    const newPreviewWidth = startPreviewWidth - deltaX;

                    // 最小幅チェック（200px）
                    if (newEditorWidth >= 200 && newPreviewWidth >= 200) {
                        const editorFlex = newEditorWidth / (containerWidth - resizerWidth);
                        const previewFlex = newPreviewWidth / (containerWidth - resizerWidth);

                        editorPane.style.flex = editorFlex;
                        previewPane.style.flex = previewFlex;
                    }
                });

                document.addEventListener('mouseup', () => {
                    if (isResizing) {
                        isResizing = false;
                        document.body.style.cursor = '';
                        document.body.style.userSelect = '';
                    }
                });
            }
        });

        function wrapSelectedTextWith(textArea, text) {
            if (!textArea) return;
            const start = textArea.selectionStart;
            const end = textArea.selectionEnd;
            const value = textArea.value;

            // 選択部分の前後にテキストを挿入
            if (text === '**') {
                //textArea.value = value.slice(0, start) + ' ' + text + value.slice(start, end) + text + ' ' + value.slice(end);
                textArea.value = value.slice(0, start) + text + value.slice(start, end) + text + value.slice(end);
                textArea.selectionStart = start + text.length; // 前後のスペースを考慮
                textArea.selectionEnd = end + text.length;
            } else {
                textArea.value = value.slice(0, start) + text + value.slice(start, end) + text + value.slice(end);
                textArea.selectionStart = start + text.length;
                textArea.selectionEnd = end + text.length;
            }
            textArea.focus();

            // プレビュー更新のために input イベントを発火
            const event = new Event('input', { bubbles: true });
            textArea.dispatchEvent(event);
        }

        function insertTextAtLineStart(textArea, text) {
            if (!textArea) return;
            const start = textArea.selectionStart;
            const end = textArea.selectionEnd;
            const value = textArea.value;

            const lineStart = value.lastIndexOf('\n', start - 1) + 1;
            const lineEnd = value.indexOf('\n', end);
            const before = value.slice(0, lineStart);
            const after = value.slice(lineEnd === -1 ? value.length : lineEnd);

            const selectedLines = value.slice(lineStart, lineEnd === -1 ? value.length : lineEnd);
            const newText = selectedLines.split('\n').map(line => text + line).join('\n');

            textArea.value = before + newText + after;
            textArea.selectionStart = lineStart;
            textArea.selectionEnd = lineStart + newText.length;

            textArea.focus();
            console.log('Inserted Text at Line Start:', text);
        }

        function insertTextAtCursor(textArea, text) {
            if (!textArea) return;
            const start = textArea.selectionStart;
            const end = textArea.selectionEnd;
            const value = textArea.value;
            textArea.value = value.slice(0, start) + text + value.slice(start);
            textArea.selectionStart = textArea.selectionEnd = start + text.length;
            textArea.focus();

            // プレビュー更新のために input イベントを手動で発火
            const event = new Event('input', { bubbles: true });
            textArea.dispatchEvent(event);
        }

        function getCurrentDate() {
            const now = new Date();
            const year = now.getFullYear();
            const month = String(now.getMonth() + 1).padStart(2, '0');
            const day = String(now.getDate()).padStart(2, '0');
            return `${year}${month}${day}`;
        }

        function getCurrentTime() {
            const now = new Date();
            const hours = String(now.getHours()).padStart(2, '0');
            const minutes = String(now.getMinutes()).padStart(2, '0');
            const seconds = String(now.getSeconds()).padStart(2, '0');
            return `${hours}${minutes}${seconds}`;
        }

        async function handlePaste(event) {
            const items = (event.clipboardData || window.clipboardData).items;
            for (let item of items) {
                if (item.kind === 'file' && item.type.startsWith('image/')) {
                    const file = item.getAsFile();
                    if (file) {
                        const formData = new FormData();
                        formData.append('file', file);

                        try {
                            const response = await fetch('/attach_upload', {
                                method: 'POST',
                                body: formData,
                                headers: {
                                    'X-CSRFToken': csrfToken  // CSRFトークンをヘッダーに追加
                                }
                            });

                            if (response.ok) {
                                const result = await response.json();
                                const filename = result.filename;
                                const url = result.url;
                                const smallImageUrl = url.replace(/\/([^\/]+)$/, '/s_$1');

                                // 改善版：title属性付きMarkdown
                                const markdownLink = result.isImage
                                    ? `[![${filename}](${smallImageUrl} "${filename}")](${url} "${filename}")`
                                    : `[${filename}](${url} "${filename}")`;

                                console.log(markdownLink);
                                insertTextAtCursor(document.getElementById('content'), markdownLink);
                            } else {
                                alert('ファイルのアップロードに失敗しました。');
                            }
                        } catch (error) {
                            console.error('アップロード中にエラーが発生しました:', error);
                            alert('ファイルのアップロードに失敗しました。');
                        }
                    }
                    event.preventDefault();
                }
            }
        }

        async function saveWithoutRedirect() {
            const content = document.getElementById('content').value;
            const formData = new FormData();
            formData.append('content', content);

            try {
                const response = await fetch(window.location.href, {
                    method: 'POST',
                    body: formData,
                    headers: {
                        'X-CSRFToken': csrfToken
                    }
                });

                if (response.ok) {
                    showTemporaryMessage('保存成功!');
                } else {
                    showTemporaryMessage('保存失敗!');
                }
            } catch (error) {
                console.error('保存中にエラーが発生しました:', error);
                showTemporaryMessage('保存失敗!');
            }
        }

        function cycleHeaderLevel(textArea) {
            if (!textArea) return;
            const start = textArea.selectionStart;
            const end = textArea.selectionEnd;
            const value = textArea.value;

            // 選択範囲を含む行の開始と終了を取得
            const lineStart = value.lastIndexOf('\n', start - 1) + 1;
            const lineEnd = value.indexOf('\n', end);
            const before = value.slice(0, lineStart);
            const after = value.slice(lineEnd === -1 ? value.length : lineEnd);

            // 選択範囲内の行を取得
            const selectedLines = value.slice(lineStart, lineEnd === -1 ? value.length : lineEnd);

            // 各行を独立してトグル
            const newText = selectedLines.split('\n').map(line => {
                // 現在の#の数を数える
                const match = line.match(/^#{1,3}\s/);
                let newPrefix = '';

                if (!match) {
                    newPrefix = '# '; // #なしから#へ
                } else {
                    const hashCount = match[0].trim().length;
                    if (hashCount < 3) {
                        newPrefix = '#'.repeat(hashCount + 1) + ' '; // 次のレベルへ
                    }
                    // hashCount === 3 の場合は newPrefix = '' のまま（#を削除）
                }

                // 既存の#を削除して新しい#を追加
                const lineWithoutHash = line.replace(/^#{1,3}\s/, '');
                return newPrefix + lineWithoutHash;
            }).join('\n');

            textArea.value = before + newText + after;
            textArea.selectionStart = lineStart;
            textArea.selectionEnd = lineStart + newText.length;
            textArea.focus();

            // プレビュー更新のために input イベントを発火
            const event = new Event('input', { bubbles: true });
            textArea.dispatchEvent(event);
        }

        function cycleDashMark(textArea) {
            if (!textArea) return;
            const start = textArea.selectionStart;
            const end = textArea.selectionEnd;
            const value = textArea.value;

            // 選択範囲を含む行の開始と終了を取得
            const lineStart = value.lastIndexOf('\n', start - 1) + 1;
            const lineEnd = value.indexOf('\n', end);
            const before = value.slice(0, lineStart);
            const after = value.slice(lineEnd === -1 ? value.length : lineEnd);

            // 選択範囲内の行を取得
            const selectedLines = value.slice(lineStart, lineEnd === -1 ? value.length : lineEnd);

            // 各行を独立してトグル
            const newText = selectedLines.split('\n').map(line => {
                const hasDash = line.match(/^- /);
                return hasDash ? line.replace(/^- /, '') : '- ' + line;
            }).join('\n');

            textArea.value = before + newText + after;
            textArea.selectionStart = lineStart;
            textArea.selectionEnd = lineStart + newText.length;
            textArea.focus();

            // プレビュー更新のために input イベントを発火
            const event = new Event('input', { bubbles: true });
            textArea.dispatchEvent(event);
        }

        function cycleNumberMark(textArea) {
            if (!textArea) return;
            const start = textArea.selectionStart;
            const end = textArea.selectionEnd;
            const value = textArea.value;

            // 選択範囲を含む行の開始と終了を取得
            const lineStart = value.lastIndexOf('\n', start - 1) + 1;
            const lineEnd = value.indexOf('\n', end);
            const before = value.slice(0, lineStart);
            const after = value.slice(lineEnd === -1 ? value.length : lineEnd);

            // 選択範囲内の行を取得
            const selectedLines = value.slice(lineStart, lineEnd === -1 ? value.length : lineEnd);

            // 各行を独立してトグル
            const newText = selectedLines.split('\n').map(line => {
                const hasNumber = line.match(/^1\. /);
                return hasNumber ? line.replace(/^1\. /, '') : '1. ' + line;
            }).join('\n');

            textArea.value = before + newText + after;
            textArea.selectionStart = lineStart;
            textArea.selectionEnd = lineStart + newText.length;
            textArea.focus();

            // プレビュー更新のために input イベントを発火
            const event = new Event('input', { bubbles: true });
            textArea.dispatchEvent(event);
        }

        function cycleQuoteMark(textArea) {
            if (!textArea) return;
            const start = textArea.selectionStart;
            const end = textArea.selectionEnd;
            const value = textArea.value;

            // 選択範囲を含む行の開始と終了を取得
            const lineStart = value.lastIndexOf('\n', start - 1) + 1;
            const lineEnd = value.indexOf('\n', end);
            const before = value.slice(0, lineStart);
            const after = value.slice(lineEnd === -1 ? value.length : lineEnd);

            // 選択範囲内の行を取得
            const selectedLines = value.slice(lineStart, lineEnd === -1 ? value.length : lineEnd);

            // 各行を独立してトグル
            const newText = selectedLines.split('\n').map(line => {
                const hasQuote = line.match(/^> /);
                return hasQuote ? line.replace(/^> /, '') : '> ' + line;
            }).join('\n');

            textArea.value = before + newText + after;
            textArea.selectionStart = lineStart;
            textArea.selectionEnd = lineStart + newText.length;
            textArea.focus();

            // プレビュー更新のために input イベントを発火
            const event = new Event('input', { bubbles: true });
            textArea.dispatchEvent(event);
        }

        function cycleFourSpaces(textArea) {
            if (!textArea) return;
            const start = textArea.selectionStart;
            const end = textArea.selectionEnd;
            const value = textArea.value;

            // 選択範囲を含む行の開始と終了を取得
            const lineStart = value.lastIndexOf('\n', start - 1) + 1;
            const lineEnd = value.indexOf('\n', end);
            const before = value.slice(0, lineStart);
            const after = value.slice(lineEnd === -1 ? value.length : lineEnd);

            // 選択範囲内の行を取得
            const selectedLines = value.slice(lineStart, lineEnd === -1 ? value.length : lineEnd);

            // 各行を独立してトグル
            const newText = selectedLines.split('\n').map(line => {
                const hasFourSpaces = line.match(/^    /); // 4つのスペースで始まるか
                return hasFourSpaces ? line.replace(/^    /, '') : '    ' + line;
            }).join('\n');

            textArea.value = before + newText + after;
            textArea.selectionStart = lineStart;
            textArea.selectionEnd = lineStart + newText.length;
            textArea.focus();

            // プレビュー更新のために input イベントを発火
            const event = new Event('input', { bubbles: true });
            textArea.dispatchEvent(event);
        }

    </script>
</head>
<body>

    <a href="/post" class="mb-2"><< post一覧へ</a>

    <form method="post" class="container" style="margin-left: 0px; margin-right: 0px; max-width: 100%">
        {{ form.hidden_tag() }} <!-- CSRFトークンを追加 -->
        <div class="btn-toolbar" role="toolbar" aria-label="Toolbar with button groups">
            <!-- グループ1: Markdown書式（使用頻度: 高） -->
            <div class="btn-group" role="group" aria-label="Markdown formatting">
                <button id="insertHashButton" type="button" class="btn btn-sm btn-outline-secondary" title="行の先頭に#を挿入">#</button>
                <button id="insertDashButton" type="button" class="btn btn-sm btn-outline-secondary" title="行の先頭に-を挿入">-</button>
                <button id="insert1Button" type="button" class="btn btn-sm btn-outline-secondary" title="行の先頭に1.を挿入">1.</button>
                <button id="insertQuoteButton" type="button" class="btn btn-sm btn-outline-secondary" title="行の先頭に>を挿入">&gt;</button>
                <button id="insertBoldButton" type="button" class="btn btn-sm btn-outline-secondary" title="選択したテキストを太字にする">B</button>
                <button id="insertSpaceButton" type="button" class="btn btn-sm btn-outline-secondary" title="行の先頭にスペースを挿入">Sp</button>
            </div>

            <!-- グループ2: 保存・プレビュー -->
            <button id="saveButton" type="button" class="btn btn-primary" title="保存 (Ctrl+S)"><i class="fas fa-save"></i></button>
            <button id="viewPageButton" type="button" class="btn btn-primary" title="プレビュー（別タブ）"><i class="fas fa-eye"></i></button>

            <!-- グループ3: 特殊機能（使用頻度: 中〜高） -->
            <button id="switchPageButton" type="button" class="btn btn-primary" title="他のページへ移動 (Ctrl+K)"><i class="fas fa-arrow-right-arrow-left"></i></button>
            <button id="aiButton" type="button" class="btn btn-primary" title="AIアシスタント"><i class="fas fa-robot"></i></button>
            <button id="previewToggleButton" type="button" class="btn btn-primary preview-toggle" title="プレビューを表示/非表示">
                <i class="fas fa-columns"></i>
            </button>

            <!-- オプションボタン（一番右に配置） -->
            <button id="insertButton" type="button" class="btn btn-primary" title="オプション"><i class="fas fa-ellipsis-v"></i></button>
        </div>
        <input type="file" id="fileInput" style="display:none;">

        行1:タイトル(#限定公開、##非公開)　行2:タグ
        <div class="editor-container">
            <div class="editor-pane">
                <textarea id="content" name="content" class="form-control" rows="10">{{ content|safe }}</textarea>
            </div>
            <div class="resizer" id="resizer"></div>
            <div class="preview-pane main-content hidden" id="previewPane">
                <div id="preview-content"></div>
            </div>
        </div>
    </form>

    <div id="overlay" class="overlay">
        <div class="dialog">
            チャット入力モード
            <input type="text" id="lineTextInput" class="form-control" placeholder="Enter text">
            <button id="lineAttachButton" class="btn btn-secondary">
                <i class="fas fa-paperclip"></i>
            </button>
        </div>
    </div>

    <!-- 挿入オーバーレイ -->
    <div id="insertOverlay" class="overlay">
        <div class="dialog">
            <h5>オプション</h5>
            <button id="insertDateButton" type="button" class="btn btn-primary btn-block mb-2" title="現在の日付を挿入">
                📅 日付 (YYYYMMDD)
            </button>
            <button id="insertTimeButton" type="button" class="btn btn-primary btn-block mb-2" title="現在の時刻を挿入">
                🕐 時刻 (hhmmss)
            </button>
            <button id="uploadFileButton" type="button" class="btn btn-primary btn-block mb-2" title="ファイルをアップロード">
                📎 ファイル
            </button>
            <button id="pasteMermaidButton" type="button" class="btn btn-primary btn-block mb-2" title="Mermaid書式を挿入">
                📊 Mermaid書式
            </button>
            <button id="backupButton" type="button" class="btn btn-primary btn-block mb-2" title="バックアップを確認">
                🗄️ バックアップ確認
            </button>
            <button id="lineButton" type="button" class="btn btn-primary btn-block mb-2" title="チャット入力モードを開く">
                💬 チャット入力
            </button>
            <button id="insertCancelButton" type="button" class="btn btn-secondary btn-block">
                キャンセル
            </button>
        </div>
    </div>

    <!-- AIモーダル（2タブ構成） -->
    <div id="aiOverlay" class="overlay">
        <div class="dialog ai-dialog">
            <h5>AIアシスタント</h5>

            <!-- タブナビゲーション -->
            <ul class="nav nav-tabs" role="tablist">
                <li class="nav-item" role="presentation">
                    <button class="nav-link active" id="template-tab" data-bs-toggle="tab" data-bs-target="#template-panel" type="button" role="tab">テンプレート</button>
                </li>
                <li class="nav-item" role="presentation">
                    <button class="nav-link" id="settings-tab" data-bs-toggle="tab" data-bs-target="#settings-panel" type="button" role="tab">設定</button>
                </li>
            </ul>

            <!-- タブコンテンツ -->
            <div class="tab-content" style="margin-top: 10px;">
                <!-- テンプレートタブ -->
                <div class="tab-pane fade show active" id="template-panel" role="tabpanel">
                    <div id="aiContextPreview" class="ai-context-preview" style="display:none;"></div>

                    <!-- プロンプトテンプレート選択 -->
                    <div class="mb-3">
                        <label for="templateSelect" class="form-label">テンプレート</label>
                        <select id="templateSelect" class="form-select">
                            <option value="">-- テンプレートを選択 --</option>
                            <!-- JavaScriptで動的に生成 -->
                        </select>
                    </div>

                    <!-- 追加指示入力欄 -->
                    <textarea id="aiPromptInput" class="form-control" rows="3" placeholder="追加の指示があればこちらに入力してください（Ctrl+Enterで送信）"></textarea>

                    <div style="display: flex; gap: 10px; margin-top: 10px;">
                        <button id="aiSendButton" class="btn btn-primary" style="flex: 1;">
                            <span id="aiButtonText">送信</span>
                            <span id="aiSpinner" style="display: none;">
                                <i class="fas fa-spinner fa-spin"></i> 処理中...
                            </span>
                        </button>
                        <button id="aiCancelButton" class="btn btn-secondary">キャンセル</button>
                    </div>
                </div>

                <!-- 設定タブ -->
                <div class="tab-pane fade" id="settings-panel" role="tabpanel">
                    <div style="margin-top: 10px;">
                        <label for="systemPromptSelect" class="form-label">システムプロンプト</label>
                        <select id="systemPromptSelect" class="form-select">
                            <!-- JavaScriptで動的に生成 -->
                        </select>
                        <div class="form-text">AIの振る舞いを設定できます</div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- ページ切り替えオーバーレイ（新規追加） -->
    <div id="switchPageOverlay" class="overlay">
        <div class="dialog">
            <h5>他のページへ移動 <small class="text-muted">(Ctrl+K)</small></h5>

            <div class="page-list" id="pageList">
                {% for post in recent_posts %}
                <div class="page-item"
                     data-filename="{{ post.filename }}"
                     data-index="{{ loop.index0 }}">
                    <div class="page-date">
                        <i class="fas fa-clock"></i> {{ post.date }}
                    </div>
                    <div class="page-title">{{ post.title }}</div>
                    <div class="page-filename">{{ post.filename }}</div>
                </div>
                {% endfor %}
            </div>

            <button id="switchPageCancelButton" type="button" class="btn btn-secondary btn-block">
                キャンセル (ESC)
            </button>
        </div>
    </div>

    <!-- バックアップ一覧オーバーレイ -->
    <div id="backupListOverlay" class="overlay">
        <div class="dialog">
            <h5>バックアップ一覧 <small class="text-muted">（最新10件）</small></h5>

            <div class="page-list" id="backupList">
                <!-- JavaScriptで動的生成 -->
            </div>

            <button id="backupListCancelButton" type="button" class="btn btn-secondary btn-block">
                キャンセル (ESC)
            </button>
        </div>
    </div>

    <!-- バックアップ内容表示オーバーレイ -->
    <div id="backupContentOverlay" class="overlay" style="z-index: 3500;">
        <div class="dialog backup-content-dialog" style="max-width: 90%; width: 1200px; max-height: 90vh;">
            <!-- ヘッダー -->
            <div class="backup-content-header">
                <h5 id="backupContentTitle">バックアップ内容</h5>
            </div>

            <!-- コンテンツエリア（スクロール可能） -->
            <div class="backup-content-body">
                <!-- 通常表示エリア -->
                <textarea id="backupContentText" class="form-control" readonly style="font-family: monospace; display: block; height: 100%; width: 100%; resize: none; border: none;"></textarea>

                <!-- 差分表示エリア（初期状態は非表示） -->
                <div id="backupContentDiff" style="display: none; height: 100%; overflow-y: auto; background: white; padding: 10px; font-family: monospace; white-space: pre-wrap; line-height: 1.6;"></div>
            </div>

            <!-- ボタンバー（下部固定） -->
            <div class="backup-content-footer">
                <button id="backupCopyButton" class="btn btn-outline-primary" title="コピー">
                    <i class="fas fa-copy"></i> コピー
                </button>
                <button id="backupDiffButton" class="btn btn-outline-secondary" title="差分表示">
                    <i class="fas fa-code-compare"></i> 差分
                </button>
                <button id="backupRestoreButton" class="btn btn-warning" title="復元">
                    <i class="fas fa-undo"></i> 復元
                </button>
                <button id="backupContentCloseButton" type="button" class="btn btn-secondary">
                    <i class="fas fa-times"></i> 閉じる
                </button>
            </div>
        </div>
    </div>

    <!-- diff-match-patchライブラリ -->
    <script src="/static/diff_match_patch.js"></script>

    <script src="/static/jquery-3.7.0.min.js"></script>
    <script src="/static/popper.min.js"></script>
    <script src="/static/bootstrap.min.js"></script>
    <script src="/static/scripts.js"></script>
    <script src="/static/upload.js"></script>

    <!-- Markdown rendering libraries for preview -->
    <script src="/static/marked.min.js"></script>
    <script src="/static/mermaid.min.js"></script>
    <script src="/static/slideshow.js"></script>

<!-- スライドショーモーダル -->
<div class="slideshow-modal" id="slideshow-modal">
    <div class="slideshow-container" id="slideshow-container">
        <button class="slideshow-close" onclick="closeSlideshowModal()">&times;</button>
        <button class="slideshow-nav prev" onclick="navigateSlideshow(-1)">
            <i class="fas fa-chevron-left"></i>
        </button>
        <img class="slideshow-image" id="slideshow-image" src="" alt="">
        <button class="slideshow-nav next" onclick="navigateSlideshow(1)">
            <i class="fas fa-chevron-right"></i>
        </button>
        <div class="slideshow-counter" id="slideshow-counter">1 / 1</div>
    </div>
</div>

<!-- ファイルアップロードスピナー -->
<div id="uploadSpinner" class="overlay" style="display: none;">
    <div style="background: white; padding: 40px; border-radius: 10px; text-align: center; min-width: 350px;">
        <i class="fas fa-spinner fa-spin fa-3x" style="color: #0d6efd;"></i>
        <p style="margin-top: 20px; font-size: 18px; font-weight: bold;">
            アップロード中...
        </p>
        <p style="font-size: 16px; color: #0d6efd;">
            <span id="uploadProgress">0/0</span>
        </p>
        <div style="margin-top: 15px; padding: 10px; background-color: #f8f9fa; border-radius: 5px;">
            <div style="font-size: 14px; color: #666; margin-bottom: 5px;">現在処理中:</div>
            <div id="currentFileName" style="font-size: 13px; color: #333; font-weight: 500;">準備中...</div>
        </div>
        <div style="margin-top: 15px; font-size: 12px; color: #999;">
            しばらくお待ちください
        </div>
    </div>
</div>

<script>
// ページ切り替え機能
(function() {
    const overlay = document.getElementById('switchPageOverlay');
    const pageList = document.getElementById('pageList');
    const pageItems = pageList ? pageList.querySelectorAll('.page-item') : [];
    let selectedIndex = 0;

    // Ctrl+K でオーバーレイを開く
    document.addEventListener('keydown', function(event) {
        // Ctrl+K または Cmd+K
        if ((event.ctrlKey || event.metaKey) && event.key === 'k') {
            event.preventDefault();
            openSwitchPageOverlay();
        }
    });

    // オーバーレイを開く
    function openSwitchPageOverlay() {
        overlay.style.display = 'flex';
        selectedIndex = 0;
        updateSelection();

        // オーバーレイ内のキーボードイベント
        document.addEventListener('keydown', handleOverlayKeydown);
    }

    // オーバーレイを閉じる
    function closeSwitchPageOverlay() {
        overlay.style.display = 'none';
        document.removeEventListener('keydown', handleOverlayKeydown);
    }

    // オーバーレイ内でのキーボード操作
    function handleOverlayKeydown(event) {
        if (overlay.style.display !== 'flex') return;

        switch(event.key) {
            case 'ArrowDown':
                event.preventDefault();
                selectedIndex = Math.min(selectedIndex + 1, pageItems.length - 1);
                updateSelection();
                break;

            case 'ArrowUp':
                event.preventDefault();
                selectedIndex = Math.max(selectedIndex - 1, 0);
                updateSelection();
                break;

            case 'Enter':
                event.preventDefault();
                event.stopPropagation(); // イベント伝播を停止（グローバルハンドラーを防ぐ）
                if (pageItems[selectedIndex]) {
                    const filename = pageItems[selectedIndex].dataset.filename;
                    // Ctrl+Enter: 新しいタブで開く（モーダルは残す）
                    if (event.ctrlKey || event.metaKey) {
                        navigateToPage(filename, true);
                    } else {
                        // 通常Enter: 現在のタブで遷移（モーダルを閉じる）
                        navigateToPage(filename, false);
                    }
                }
                break;

            case 'Escape':
                event.preventDefault();
                closeSwitchPageOverlay();
                break;
        }
    }

    // 選択状態を更新
    function updateSelection() {
        pageItems.forEach((item, index) => {
            if (index === selectedIndex) {
                item.classList.add('selected');
                // スクロールして表示
                item.scrollIntoView({ block: 'nearest', behavior: 'smooth' });
            } else {
                item.classList.remove('selected');
            }
        });
    }

    // ページに移動
    window.navigateToPage = function(filename, openInNewTab = false) {
        if (openInNewTab) {
            // 新しいタブで開く（モーダルは残す）
            window.open('/edit_post/' + filename, '_blank');
        } else {
            // 現在のタブで遷移（モーダルを閉じる）
            closeSwitchPageOverlay();
            location.href = '/edit_post/' + filename;
        }
    };

    // ページ切り替えボタン
    const switchPageButton = document.getElementById('switchPageButton');
    if (switchPageButton) {
        switchPageButton.addEventListener('click', function() {
            openSwitchPageOverlay();
        });
    }

    // キャンセルボタン
    const cancelButton = document.getElementById('switchPageCancelButton');
    if (cancelButton) {
        cancelButton.addEventListener('click', function() {
            closeSwitchPageOverlay();
        });
    }

    // オーバーレイの背景クリックで閉じる
    overlay.addEventListener('click', function(event) {
        if (event.target === overlay) {
            closeSwitchPageOverlay();
        }
    });

    // マウスホバーで選択状態を変更
    pageItems.forEach((item, index) => {
        item.addEventListener('mouseenter', function() {
            selectedIndex = index;
            updateSelection();
        });

        // クリックイベント（Ctrl+クリック対応）
        item.addEventListener('click', function(event) {
            const filename = item.dataset.filename;
            // Ctrl+クリック または Cmd+クリック: 新しいタブで開く（モーダルは残す）
            if (event.ctrlKey || event.metaKey) {
                event.preventDefault();
                navigateToPage(filename, true);
            } else {
                // 通常クリック: 現在のタブで遷移（モーダルを閉じる）
                navigateToPage(filename, false);
            }
        });
    });
})();
</script>

<script>
// バックアップ確認機能
(function() {
    const currentFilename = "{{ filename }}";
    const backupButton = document.getElementById('backupButton');
    const insertOverlay = document.getElementById('insertOverlay');
    const backupListOverlay = document.getElementById('backupListOverlay');
    const backupContentOverlay = document.getElementById('backupContentOverlay');
    const backupList = document.getElementById('backupList');
    let backupItems = [];
    let selectedBackupIndex = 0;
    let currentBackupContent = '';
    let isDiffMode = false;

    // バックアップボタンクリック
    if (backupButton) {
        backupButton.addEventListener('click', async () => {
            insertOverlay.style.display = 'none';
            await loadBackupList();
            backupListOverlay.style.display = 'flex';
            selectedBackupIndex = 0;
            updateBackupSelection();
        });
    }

    // バックアップ一覧を取得
    async function loadBackupList() {
        try {
            const response = await fetch(`/api/backups/${currentFilename}`, {
                headers: { 'X-CSRFToken': csrfToken }
            });

            if (response.ok) {
                const data = await response.json();
                renderBackupList(data.backups);
            } else {
                alert('バックアップの取得に失敗しました');
            }
        } catch (error) {
            console.error('Error loading backups:', error);
            alert('エラーが発生しました');
        }
    }

    // バックアップ一覧を描画
    function renderBackupList(backups) {
        backupList.innerHTML = '';
        backupItems = [];

        if (backups.length === 0) {
            backupList.innerHTML = '<div style="padding: 20px; text-align: center; color: #999;">バックアップがありません</div>';
            return;
        }

        backups.forEach((backup, index) => {
            const item = document.createElement('div');
            item.className = 'backup-item';
            item.dataset.filename = backup.filename;
            item.dataset.index = index;

            item.innerHTML = `
                <div class="backup-date">
                    <i class="fas fa-clock"></i> ${backup.date}
                    <span class="backup-relative-time">(${backup.relative_time})</span>
                </div>
                <div class="backup-filename">${backup.filename}</div>
            `;

            // クリックイベント
            item.addEventListener('click', () => {
                selectedBackupIndex = index;
                updateBackupSelection();
                openBackupContent(backup.filename);
            });

            // ホバーイベント
            item.addEventListener('mouseenter', () => {
                selectedBackupIndex = index;
                updateBackupSelection();
            });

            backupList.appendChild(item);
            backupItems.push(item);
        });
    }

    // 選択状態を更新
    function updateBackupSelection() {
        backupItems.forEach((item, index) => {
            if (index === selectedBackupIndex) {
                item.classList.add('selected');
                item.scrollIntoView({ block: 'nearest', behavior: 'smooth' });
            } else {
                item.classList.remove('selected');
            }
        });
    }

    // キーボード操作（バックアップ一覧）
    document.addEventListener('keydown', (event) => {
        if (backupListOverlay.style.display !== 'flex') return;

        switch(event.key) {
            case 'ArrowDown':
                event.preventDefault();
                selectedBackupIndex = Math.min(selectedBackupIndex + 1, backupItems.length - 1);
                updateBackupSelection();
                break;
            case 'ArrowUp':
                event.preventDefault();
                selectedBackupIndex = Math.max(selectedBackupIndex - 1, 0);
                updateBackupSelection();
                break;
            case 'Enter':
                event.preventDefault();
                if (backupItems[selectedBackupIndex]) {
                    const filename = backupItems[selectedBackupIndex].dataset.filename;
                    openBackupContent(filename);
                }
                break;
            case 'Escape':
                event.preventDefault();
                backupListOverlay.style.display = 'none';
                break;
        }
    });

    // バックアップ内容を表示
    async function openBackupContent(backupFilename) {
        try {
            const response = await fetch(`/api/backup_content/${encodeURIComponent(backupFilename)}`, {
                headers: { 'X-CSRFToken': csrfToken }
            });

            if (response.ok) {
                const data = await response.json();
                currentBackupContent = data.content;

                document.getElementById('backupContentTitle').textContent = `バックアップ内容: ${backupFilename}`;
                document.getElementById('backupContentText').value = data.content;

                // 初期状態は通常表示
                isDiffMode = false;
                document.getElementById('backupContentText').style.display = 'block';
                document.getElementById('backupContentDiff').style.display = 'none';
                document.getElementById('backupDiffButton').classList.remove('active');
                document.getElementById('backupDiffButton').innerHTML = '<i class="fas fa-code-compare"></i> 差分';

                backupContentOverlay.style.display = 'flex';
            } else {
                alert('バックアップ内容の取得に失敗しました');
            }
        } catch (error) {
            console.error('Error loading backup content:', error);
            alert('エラーが発生しました');
        }
    }

    // 差分ボタン
    const backupDiffButton = document.getElementById('backupDiffButton');
    if (backupDiffButton) {
        backupDiffButton.addEventListener('click', () => {
            toggleDiffMode();
        });
    }

    // 差分表示モードの切り替え
    function toggleDiffMode() {
        isDiffMode = !isDiffMode;

        const textArea = document.getElementById('backupContentText');
        const diffDiv = document.getElementById('backupContentDiff');
        const diffButton = document.getElementById('backupDiffButton');

        if (isDiffMode) {
            // 差分表示モードに切り替え
            textArea.style.display = 'none';
            diffDiv.style.display = 'block';
            diffButton.classList.add('active');
            diffButton.innerHTML = '<i class="fas fa-file-alt"></i> 通常';

            // 差分を計算して表示
            renderDiffHighlight();
        } else {
            // 通常表示モードに切り替え
            textArea.style.display = 'block';
            diffDiv.style.display = 'none';
            diffButton.classList.remove('active');
            diffButton.innerHTML = '<i class="fas fa-code-compare"></i> 差分';
        }
    }

    // 差分をハイライト表示
    function renderDiffHighlight() {
        const backupText = currentBackupContent;
        const currentText = document.getElementById('content').value;

        const dmp = new diff_match_patch();
        const diffs = dmp.diff_main(backupText, currentText);
        dmp.diff_cleanupSemantic(diffs);

        let html = '';
        let lineNumber = 1;

        diffs.forEach(([operation, text]) => {
            const lines = text.split('\n');

            lines.forEach((line, index) => {
                let lineClass = '';
                let prefix = '';

                if (operation === -1) {
                    // 削除された行（バックアップにあるが現在はない）
                    lineClass = 'diff-line-deleted';
                    prefix = '- ';
                } else if (operation === 1) {
                    // 追加された行（バックアップになく現在ある）
                    lineClass = 'diff-line-added';
                    prefix = '+ ';
                } else {
                    // 変更なし
                    lineClass = 'diff-line-normal';
                    prefix = '  ';
                }

                html += `<div class="diff-line ${lineClass}">` +
                       `<span class="diff-line-number">${lineNumber}</span>` +
                       escapeHtml(prefix + line) +
                       `</div>`;

                if (operation !== 1) {
                    lineNumber++;
                }
            });
        });

        document.getElementById('backupContentDiff').innerHTML = html;
    }

    // HTMLエスケープ
    function escapeHtml(text) {
        const div = document.createElement('div');
        div.textContent = text;
        return div.innerHTML;
    }

    // コピーボタン
    const backupCopyButton = document.getElementById('backupCopyButton');
    if (backupCopyButton) {
        backupCopyButton.addEventListener('click', () => {
            let content = '';

            if (isDiffMode) {
                // 差分モードの場合：削除行と通常行のみをコピー
                const diffDiv = document.getElementById('backupContentDiff');
                const lines = diffDiv.querySelectorAll('.diff-line');

                lines.forEach(line => {
                    if (!line.classList.contains('diff-line-added')) {
                        const text = line.textContent;
                        const lineContent = text.substring(text.indexOf(' ', 5) + 1);
                        content += lineContent + '\n';
                    }
                });
                content = content.trimEnd();
            } else {
                // 通常モードの場合：そのままコピー
                content = document.getElementById('backupContentText').value;
            }

            navigator.clipboard.writeText(content).then(() => {
                showTemporaryMessage('コピーしました！');
            });
        });
    }

    // 復元ボタン
    const backupRestoreButton = document.getElementById('backupRestoreButton');
    if (backupRestoreButton) {
        backupRestoreButton.addEventListener('click', () => {
            if (confirm('現在の編集内容をバックアップ内容で置き換えますか？\n（この操作は元に戻せません）')) {
                document.getElementById('content').value = currentBackupContent;
                backupContentOverlay.style.display = 'none';
                backupListOverlay.style.display = 'none';
                showTemporaryMessage('復元しました！');

                // プレビュー更新
                const event = new Event('input', { bubbles: true });
                document.getElementById('content').dispatchEvent(event);
            }
        });
    }

    // 閉じるボタン
    const backupContentCloseButton = document.getElementById('backupContentCloseButton');
    if (backupContentCloseButton) {
        backupContentCloseButton.addEventListener('click', () => {
            backupContentOverlay.style.display = 'none';
        });
    }

    const backupListCancelButton = document.getElementById('backupListCancelButton');
    if (backupListCancelButton) {
        backupListCancelButton.addEventListener('click', () => {
            backupListOverlay.style.display = 'none';
        });
    }

    // ESCキー（バックアップ内容表示）
    document.addEventListener('keydown', (event) => {
        if (event.key === 'Escape' && backupContentOverlay.style.display === 'flex') {
            event.preventDefault();
            backupContentOverlay.style.display = 'none';
        }
    });

    // 背景クリック
    if (backupListOverlay) {
        backupListOverlay.addEventListener('click', (event) => {
            if (event.target === backupListOverlay) {
                backupListOverlay.style.display = 'none';
            }
        });
    }

    if (backupContentOverlay) {
        backupContentOverlay.addEventListener('click', (event) => {
            if (event.target === backupContentOverlay) {
                backupContentOverlay.style.display = 'none';
            }
        });
    }
})();
</script>

</body>
</html>