<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">

    <title>Edit: {{ title }}</title>

    <!-- Favicon -->
    <link rel="icon" type="image/x-icon" href="/static/favicon.ico">
    <link rel="icon" type="image/png" sizes="16x16" href="/static/favicon-16x16.png">
    <link rel="icon" type="image/png" sizes="32x32" href="/static/favicon-32x32.png">
    <link rel="apple-touch-icon" sizes="180x180" href="/static/favicon-180x180.png">
    <link rel="icon" type="image/png" sizes="192x192" href="/static/favicon-192x192.png">

    <link rel="stylesheet" href="/static/styles.css">
    <link rel="stylesheet" href="/static/bootstrap.min.css">
    <link rel="stylesheet" href="https://use.fontawesome.com/releases/v6.5.2/css/all.css">
    <link rel="stylesheet" href="/static/post-content-style.css">
    <link rel="stylesheet" href="/static/slideshow.css">
    <link rel="stylesheet" href="/static/edit_post.css">
</head>
<body data-filename="{{ filename }}" data-csrf-token="{{ form.csrf_token._value() }}" data-post-url="{{ url_for('post', filename=request.view_args['filename']) }}">

    <a href="/post" class="mb-2"><< post一覧へ</a>

    <form method="post" class="container" style="margin-left: 0px; margin-right: 0px; max-width: 100%">
        {{ form.hidden_tag() }} <!-- CSRFトークンを追加 -->
        <div class="btn-toolbar" role="toolbar" aria-label="Toolbar with button groups">
            <!-- グループ1: Markdown書式（使用頻度: 高） -->
            <div class="btn-group" role="group" aria-label="Markdown formatting">
                <button id="insertHashButton" type="button" class="btn btn-sm btn-outline-secondary" title="行の先頭に#を挿入">#</button>
                <button id="insertDashButton" type="button" class="btn btn-sm btn-outline-secondary" title="行の先頭に-を挿入">-</button>
                <button id="insert1Button" type="button" class="btn btn-sm btn-outline-secondary" title="行の先頭に1.を挿入">1.</button>
                <button id="insertQuoteButton" type="button" class="btn btn-sm btn-outline-secondary" title="行の先頭に>を挿入">&gt;</button>
                <button id="insertBoldButton" type="button" class="btn btn-sm btn-outline-secondary" title="選択したテキストを太字にする">B</button>
                <button id="insertSpaceButton" type="button" class="btn btn-sm btn-outline-secondary" title="行の先頭にスペースを挿入">Sp</button>
            </div>

            <!-- グループ2: 保存・プレビュー -->
            <button id="saveButton" type="button" class="btn btn-primary" title="保存 (Ctrl+S)"><i class="fas fa-save"></i></button>
            <a href="{{ url_for('post', filename=request.view_args['filename']) }}" id="viewPageButton" class="btn btn-primary" title="プレビュー"><i class="fas fa-eye"></i></a>

            <!-- グループ3: 特殊機能（使用頻度: 中〜高） -->
            <button id="switchPageButton" type="button" class="btn btn-primary" title="他のページへ移動 (Ctrl+K)"><i class="fas fa-arrow-right-arrow-left"></i></button>
            <button id="aiButton" type="button" class="btn btn-primary" title="AIアシスタント"><i class="fas fa-robot"></i></button>
            <button id="previewToggleButton" type="button" class="btn btn-primary preview-toggle" title="プレビューを表示/非表示">
                <i class="fas fa-columns"></i>
            </button>

            <!-- オプションボタン（一番右に配置） -->
            <button id="insertButton" type="button" class="btn btn-primary" title="オプション"><i class="fas fa-ellipsis-v"></i></button>
        </div>
        <input type="file" id="fileInput" style="display:none;">

        行1:タイトル(#限定公開、##非公開)　行2:タグ
        <div class="editor-container">
            <div class="editor-pane">
                <textarea id="content" name="content" class="form-control" rows="10">{{ content|safe }}</textarea>
            </div>
            <div class="resizer" id="resizer"></div>
            <div class="preview-pane main-content hidden" id="previewPane">
                <div id="preview-content"></div>
            </div>
        </div>
    </form>

    <div id="overlay" class="overlay">
        <div class="dialog">
            チャット入力モード
            <input type="text" id="lineTextInput" class="form-control" placeholder="Enter text">
            <button id="lineAttachButton" class="btn btn-secondary">
                <i class="fas fa-paperclip"></i>
            </button>
        </div>
    </div>

    <!-- 挿入オーバーレイ -->
    <div id="insertOverlay" class="overlay">
        <div class="dialog">
            <h5>オプション</h5>
            <button id="newPostButton" type="button" class="btn btn-primary btn-block mb-2" title="新しい投稿を作成">
                📝 New Post
            </button>
            <button id="insertDateButton" type="button" class="btn btn-primary btn-block mb-2" title="現在の日付を挿入">
                📅 日付 (YYYYMMDD) を挿入
            </button>
            <button id="insertTimeButton" type="button" class="btn btn-primary btn-block mb-2" title="現在の時刻を挿入">
                🕐 時刻 (hhmmss) を挿入
            </button>
            <button id="uploadFileButton" type="button" class="btn btn-primary btn-block mb-2" title="ファイルをアップロード">
                📎 ファイル
            </button>
            <button id="pasteMermaidButton" type="button" class="btn btn-primary btn-block mb-2" title="Mermaid書式を挿入">
                📊 Mermaid書式を挿入
            </button>
            <button id="copyFilenameButton" type="button" class="btn btn-primary btn-block mb-2" title="ファイル名をコピー">
                📋 ファイル名をコピー
            </button>
            <button id="backupButton" type="button" class="btn btn-primary btn-block mb-2" title="バックアップを確認">
                🗄️ バックアップ確認
            </button>
            <button id="lineButton" type="button" class="btn btn-primary btn-block mb-2" title="チャット入力モードを開く">
                💬 チャット入力
            </button>
            <button id="insertCancelButton" type="button" class="btn btn-secondary btn-block">
                キャンセル
            </button>
        </div>
    </div>

    <!-- AIモーダル（2タブ構成） -->
    <div id="aiOverlay" class="overlay">
        <div class="dialog ai-dialog">
            <h5>AIアシスタント</h5>

            <!-- タブナビゲーション -->
            <ul class="nav nav-tabs" role="tablist">
                <li class="nav-item" role="presentation">
                    <button class="nav-link active" id="template-tab" data-bs-toggle="tab" data-bs-target="#template-panel" type="button" role="tab">テンプレート</button>
                </li>
                <li class="nav-item" role="presentation">
                    <button class="nav-link" id="settings-tab" data-bs-toggle="tab" data-bs-target="#settings-panel" type="button" role="tab">設定</button>
                </li>
            </ul>

            <!-- タブコンテンツ -->
            <div class="tab-content" style="margin-top: 10px;">
                <!-- テンプレートタブ -->
                <div class="tab-pane fade show active" id="template-panel" role="tabpanel">
                    <div id="aiContextPreview" class="ai-context-preview" style="display:none;"></div>

                    <!-- プロンプトテンプレート選択 -->
                    <div class="mb-3">
                        <label for="templateSelect" class="form-label">テンプレート</label>
                        <select id="templateSelect" class="form-select">
                            <option value="">-- テンプレートを選択 --</option>
                            <!-- JavaScriptで動的に生成 -->
                        </select>
                    </div>

                    <!-- 追加指示入力欄 -->
                    <textarea id="aiPromptInput" class="form-control" rows="3" placeholder="追加の指示があればこちらに入力してください（Ctrl+Enterで送信）"></textarea>

                    <div style="display: flex; gap: 10px; margin-top: 10px;">
                        <button id="aiSendButton" class="btn btn-primary" style="flex: 1;">
                            <span id="aiButtonText">送信</span>
                            <span id="aiSpinner" style="display: none;">
                                <i class="fas fa-spinner fa-spin"></i> 処理中...
                            </span>
                        </button>
                        <button id="aiCancelButton" class="btn btn-secondary">キャンセル</button>
                    </div>
                </div>

                <!-- 設定タブ -->
                <div class="tab-pane fade" id="settings-panel" role="tabpanel">
                    <div style="margin-top: 10px;">
                        <label for="systemPromptSelect" class="form-label">システムプロンプト</label>
                        <select id="systemPromptSelect" class="form-select">
                            <!-- JavaScriptで動的に生成 -->
                        </select>
                        <div class="form-text">AIの振る舞いを設定できます</div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- ページ切り替えオーバーレイ（新規追加） -->
    <div id="switchPageOverlay" class="overlay">
        <div class="dialog">
            <h5>他のページへ移動 <small class="text-muted">(Ctrl+K)</small></h5>

            <div class="page-list" id="pageList">
                {% for post in recent_posts %}
                <div class="page-item"
                     data-filename="{{ post.filename }}"
                     data-index="{{ loop.index0 }}">
                    <div class="page-date">
                        <i class="fas fa-clock"></i> {{ post.date }}
                    </div>
                    <div class="page-title">{{ post.title }}</div>
                    <div class="page-filename">{{ post.filename }}</div>
                </div>
                {% endfor %}
            </div>

            <button id="switchPageCancelButton" type="button" class="btn btn-secondary btn-block">
                キャンセル (ESC)
            </button>
        </div>
    </div>

    <!-- バックアップ一覧オーバーレイ -->
    <div id="backupListOverlay" class="overlay">
        <div class="dialog">
            <h5>バックアップ一覧 <small class="text-muted">（最新10件）</small></h5>

            <div class="page-list" id="backupList">
                <!-- JavaScriptで動的生成 -->
            </div>

            <button id="backupListCancelButton" type="button" class="btn btn-secondary btn-block">
                キャンセル (ESC)
            </button>
        </div>
    </div>

    <!-- バックアップ内容表示オーバーレイ -->
    <div id="backupContentOverlay" class="overlay" style="z-index: 3500;">
        <div class="dialog backup-content-dialog" style="max-width: 90%; width: 1200px; max-height: 90vh;">
            <!-- ヘッダー -->
            <div class="backup-content-header">
                <h5 id="backupContentTitle">バックアップ内容</h5>
            </div>

            <!-- コンテンツエリア（スクロール可能） -->
            <div class="backup-content-body">
                <!-- 通常表示エリア -->
                <textarea id="backupContentText" class="form-control" readonly style="font-family: monospace; display: block; height: 100%; width: 100%; resize: none; border: none;"></textarea>

                <!-- 差分表示エリア（初期状態は非表示） -->
                <div id="backupContentDiff" style="display: none; height: 100%; overflow-y: auto; background: white; padding: 10px; font-family: monospace; white-space: pre-wrap; line-height: 1.6;"></div>
            </div>

            <!-- ボタンバー（下部固定） -->
            <div class="backup-content-footer">
                <button id="backupCopyButton" class="btn btn-outline-primary" title="コピー">
                    <i class="fas fa-copy"></i> コピー
                </button>
                <button id="backupDiffButton" class="btn btn-outline-secondary" title="差分表示">
                    <i class="fas fa-code-compare"></i> 差分
                </button>
                <button id="backupRestoreButton" class="btn btn-warning" title="復元">
                    <i class="fas fa-undo"></i> 復元
                </button>
                <button id="backupContentCloseButton" type="button" class="btn btn-secondary">
                    <i class="fas fa-times"></i> 閉じる
                </button>
            </div>
        </div>
    </div>

    <!-- diff-match-patchライブラリ -->
    <script src="/static/diff_match_patch.js"></script>

    <script src="/static/jquery-3.7.0.min.js"></script>
    <script src="/static/popper.min.js"></script>
    <script src="/static/bootstrap.min.js"></script>
    <script src="/static/scripts.js"></script>
    <script src="/static/upload.js"></script>

    <!-- Markdown rendering libraries for preview -->
    <script src="/static/marked.min.js"></script>
    <script src="/static/mermaid.min.js"></script>
    <script src="/static/slideshow.js"></script>
    <script src="/static/edit_post.js"></script>

<!-- スライドショーモーダル -->
<div class="slideshow-modal" id="slideshow-modal">
    <div class="slideshow-container" id="slideshow-container">
        <button class="slideshow-close" onclick="closeSlideshowModal()">&times;</button>
        <button class="slideshow-nav prev" onclick="navigateSlideshow(-1)">
            <i class="fas fa-chevron-left"></i>
        </button>
        <img class="slideshow-image" id="slideshow-image" src="" alt="">
        <button class="slideshow-nav next" onclick="navigateSlideshow(1)">
            <i class="fas fa-chevron-right"></i>
        </button>
        <div class="slideshow-counter" id="slideshow-counter">1 / 1</div>
    </div>
</div>

<!-- ファイルアップロードスピナー -->
<div id="uploadSpinner" class="overlay" style="display: none;">
    <div style="background: white; padding: 40px; border-radius: 10px; text-align: center; min-width: 350px;">
        <i class="fas fa-spinner fa-spin fa-3x" style="color: #0d6efd;"></i>
        <p style="margin-top: 20px; font-size: 18px; font-weight: bold;">
            アップロード中...
        </p>
        <p style="font-size: 16px; color: #0d6efd;">
            <span id="uploadProgress">0/0</span>
        </p>
        <div style="margin-top: 15px; padding: 10px; background-color: #f8f9fa; border-radius: 5px;">
            <div style="font-size: 14px; color: #666; margin-bottom: 5px;">現在処理中:</div>
            <div id="currentFileName" style="font-size: 13px; color: #333; font-weight: 500;">準備中...</div>
        </div>
        <div style="margin-top: 15px; font-size: 12px; color: #999;">
            しばらくお待ちください
        </div>
    </div>
</div>



</body>
</html>